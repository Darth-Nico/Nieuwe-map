<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spud Siege - Aardappel Tower Defense</title>
    <style>
        @font-face {
            font-family: 'PixelFont';
            src: url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #87CEEB; /* Lichtblauwe lucht */
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .hill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background-color: #32CD32; /* Helder groen */
            border-radius: 50% 50% 0 0;
            transform: scaleX(1.5);
        }

        .cloud {
            position: absolute;
            background-color: white;
            border-radius: 20px;
            width: 100px;
            height: 30px;
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background-color: white;
            border-radius: 50%;
        }

        .cloud::before {
            width: 50px;
            height: 50px;
            top: -20px;
            left: 15px;
        }

        .cloud::after {
            width: 40px;
            height: 40px;
            top: -15px;
            left: 50px;
        }

        .cloud:nth-child(1) {
            top: 100px;
            left: 100px;
            transform: scale(1.2);
        }

        .cloud:nth-child(2) {
            top: 150px;
            right: 180px;
            transform: scale(0.8);
        }

        .cloud:nth-child(3) {
            top: 80px;
            right: 400px;
        }

        .game-container {
            text-align: center;
            background-color: rgba(44, 24, 16, 0.9);
            backdrop-filter: blur(5px);
            padding: 2rem;
            /* Pixel-perfect randen */
            border: 4px solid #8B4513;
            box-shadow: 
                4px 4px 0 #000,
                -4px -4px 0 #B8860B;
        }

        .title {
            color: #FFD700;
            font-size: 3rem;
            text-shadow: 
                4px 4px 0 #000,
                -2px -2px 0 #8B4513;
            margin-bottom: 3rem;
            letter-spacing: 2px;
        }

        .menu-button {
            background-color: #8B4513;
            color: #FFD700;
            border: none;
            padding: 1rem 2rem;
            margin: 1rem;
            font-size: 1.2rem;
            font-family: 'Press Start 2P', cursive;
            /* Pixel-perfect randen voor knoppen */
            border: 3px solid #000;
            box-shadow: 
                3px 3px 0 #000,
                -3px -3px 0 #B8860B;
            image-rendering: pixelated;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .menu-button:hover {
            background-color: #A0522D;
            transform: translate(2px, 2px);
            box-shadow: 
                1px 1px 0 #000,
                -1px -1px 0 #B8860B;
        }

        .menu-button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }

        .potato-decoration {
            width: 120px;
            height: auto;
            margin: 1rem;
            image-rendering: pixelated;
            /* Pixel art rotatie animatie */
            animation: pixel-bounce 2s infinite;
        }

        @keyframes pixel-bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #2c1810;
            padding: 2rem;
            border: 4px solid #8B4513;
            box-shadow: 
                4px 4px 0 #000,
                -4px -4px 0 #B8860B;
            text-align: center;
            max-width: 400px;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #FFD700;
            font-size: 1.5rem;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
        }

        .settings-option {
            margin: 1.5rem 0;
            color: #FFD700;
            font-size: 1rem;
        }

        .github-link {
            color: #FFD700;
            text-decoration: none;
            font-size: 0.8rem;
            margin: 1rem 0;
            display: block;
        }

        .credits {
            color: #FFD700;
            font-size: 0.8rem;
            margin-top: 1.5rem;
        }

        .toggle-button {
            background-color: #8B4513;
            color: #FFD700;
            border: 2px solid #000;
            padding: 0.5rem 1rem;
            margin-left: 1rem;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
        }

        .toggle-button:hover {
            background-color: #A0522D;
        }

        .game-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #87CEEB;
            z-index: 100;
        }

        .game-map {
            position: relative;
            width: 100%;
            height: 100vh;
            background-color: #90EE90;
            border: none;
        }

        .path {
            position: absolute;
            background-color: #B8860B;
            border: 2px solid #8B4513;
        }

        .path.vertical {
            width: 60px;
        }

        .path.horizontal {
            height: 60px;
        }

        .path-curve {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #B8860B;
            border: 2px solid #8B4513;
        }

        .king-position {
            position: absolute;
            top: 10%;
            left: 65%;
            transform: translateX(-50%);
            z-index: 102;
        }

        .king-position img {
            width: 80px;
            height: auto;
            image-rendering: pixelated;
        }

        .game-ui {
            position: fixed;
            right: 20px;
            top: 20px;
            background-color: rgba(44, 24, 16, 0.9);
            padding: 1rem;
            border: 4px solid #8B4513;
            box-shadow: 4px 4px 0 #000;
            z-index: 101;
        }

        .wave-button {
            background-color: #8B4513;
            color: #FFD700;
            border: 3px solid #000;
            padding: 0.5rem 1rem;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .wave-button:hover {
            background-color: #A0522D;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        .wave-button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }

        .enemy {
            position: absolute !important;
            width: 40px;
            height: 40px;
            z-index: 101;
            left: 10%;
            bottom: 0;
        }

        .enemy img {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        @keyframes followPath {
            0% {
                left: 10%;
                bottom: 0;
            }
            30% {
                left: 10%;
                bottom: 30%;
            }
            45% {
                left: 40%;
                bottom: 30%;
            }
            60% {
                left: 40%;
                bottom: 60%;
            }
            75% {
                left: 70%;
                bottom: 60%;
            }
            100% {
                left: 70%;
                bottom: 100%;
            }
        }

        .wave-button.disabled {
            background-color: #5a361b;
            color: #998200;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        .wave-button.disabled:hover {
            background-color: #5a361b;
            transform: none;
            box-shadow: none;
        }

        .shop-toggle {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #8B4513;
            color: #FFD700;
            border: none;
            padding: 1rem 0.5rem;
            cursor: pointer;
            border-radius: 5px 0 0 5px;
            border: 3px solid #000;
            border-right: none;
            z-index: 102;
            display: none;
        }

        .shop-toggle:hover {
            background-color: #A0522D;
        }

        .shop-sidebar {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: rgba(44, 24, 16, 0.95);
            border-left: 4px solid #8B4513;
            padding: 1rem;
            transition: right 0.3s ease;
            z-index: 101;
            visibility: hidden;
        }

        .shop-sidebar.open {
            right: 0;
            visibility: visible;
        }

        .shop-item {
            background-color: #5a5a5a;
            border: 3px solid #000;
            padding: 1rem;
            margin: 1rem 0;
            color: #FFD700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .shop-item:hover {
            background-color: #6a6a6a;
        }

        .shop-item.selected {
            background-color: #7a7a7a;
            border-color: #FFD700;
        }

        .cannon-preview {
            display: none;
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: rgba(90, 90, 90, 0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 103;
        }

        .cannon-radius {
            position: absolute;
            width: 200px;
            height: 200px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .cannon-barrel {
            position: absolute;
            width: 12px;
            height: 6px;
            background-color: #404040;
            top: 50%;
            left: 100%;
            transform-origin: left center;
            transform: translateY(-50%);
        }

        .bullet {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #FFD700;
            border-radius: 50%;
            z-index: 101;
        }

        @keyframes shoot {
            to {
                transform: translate(var(--targetX), var(--targetY));
                opacity: 0;
            }
        }

        .placed-cannon {
            position: absolute;
            width: 40px !important;
            height: 20px !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #606060 !important;
            z-index: 102;
            transform-origin: center center;
        }

        @keyframes recoil {
            0% { transform: translateX(0) rotate(var(--rotation)); }
            20% { transform: translateX(-4px) rotate(var(--rotation)); }
            100% { transform: translateX(0) rotate(var(--rotation)); }
        }

        @keyframes flash {
            0% { 
                opacity: 1;
                transform: scale(1);
            }
            100% { 
                opacity: 0;
                transform: scale(2);
            }
        }

        .muzzle-flash {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #FFD700;
            border-radius: 50%;
            left: 100%;
            top: 50%;
            transform: translate(0, -50%);
            opacity: 0;
            pointer-events: none;
        }

        .placed-cannon.shooting {
            animation: recoil 0.2s ease-out;
        }

        .hp-bar {
            position: absolute;
            width: 40px;
            height: 4px;
            background-color: #333;
            border: 1px solid #000;
            top: -8px;
            left: 0;
        }

        .hp-fill {
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.2s ease;
        }

        .king-hp-bar {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 6px;
            background-color: #333;
            border: 1px solid #000;
        }

        .king-hp-fill {
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.2s ease;
        }

        .enemy {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="background">
        <div class="clouds">
            <div class="cloud"></div>
            <div class="cloud"></div>
            <div class="cloud"></div>
        </div>
        <div class="hill"></div>
    </div>
    <div class="game-container">
        <img src="assets/patato-king.png" alt="Aardappel Koning" class="potato-decoration">
        <h1 class="title">Spud Siege</h1>
        <div class="menu-buttons">
            <button class="menu-button" onclick="startGame()">Start Spel</button>
            <button class="menu-button" onclick="showInstructions()">Instructies</button>
            <button class="menu-button" onclick="showSettings()">Instellingen</button>
        </div>
        <img src="assets/patato-knight.png" alt="Aardappel Ridder" class="potato-decoration">
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeSettings()">×</button>
            <h2 class="title" style="font-size: 1.5rem;">Instellingen</h2>
            
            <div class="settings-option">
                Geluid: <button class="toggle-button" onclick="toggleSound()" id="soundButton">AAN</button>
            </div>

            <a href="https://github.com/darth-nico" target="_blank" class="github-link">
                github.com/darth-nico
            </a>

            <div class="credits">
                Credits: Niels Coert
            </div>
        </div>
    </div>

    <div id="gameView" class="game-view">
        <div class="game-map">
            <!-- Zigzag pad van linksonder naar rechtsboven -->
            <div class="path vertical" style="left: 10%; bottom: 0; height: 30%;"></div>
            <div class="path-curve" style="left: 10%; bottom: 30%;"></div>
            <div class="path horizontal" style="left: 10%; bottom: 30%; width: 30%;"></div>
            <div class="path-curve" style="left: 40%; bottom: 30%;"></div>
            <div class="path vertical" style="left: 40%; bottom: 30%; height: 30%;"></div>
            <div class="path-curve" style="left: 40%; bottom: 60%;"></div>
            <div class="path horizontal" style="left: 40%; bottom: 60%; width: 30%;"></div>
            <div class="path-curve" style="left: 70%; bottom: 60%;"></div>
            <div class="path vertical" style="left: 70%; bottom: 60%; height: 60%;"></div>
            
            <!-- Koning positie -->
            <div class="king-position" style="top: 10%; left: 65%;">
                <div class="king-hp-bar">
                    <div class="king-hp-fill" style="width: 100%;"></div>
                </div>
                <img src="assets/patato-king.png" alt="Koning">
            </div>
        </div>

        <!-- Game UI -->
        <div class="game-ui">
            <div class="wave-info" style="color: #FFD700; margin-bottom: 1rem; font-size: 0.8rem;">
                Wave: <span id="waveNumber">1</span>
                <div id="waveStatus" style="margin-top: 0.5rem; font-size: 0.7rem;">Klaar om te starten</div>
            </div>
            <button class="wave-button" onclick="startWave()">Start Wave</button>
        </div>
    </div>

    <div id="waveCompletionModal" class="modal">
        <div class="modal-content">
            <h2 class="title" style="font-size: 1.5rem;">Wave <span id="completedWaveNumber">1</span> Voltooid!</h2>
            <div class="wave-stats" style="color: #FFD700; margin: 1rem 0; text-align: left; font-size: 0.8rem;">
                <div>Vijanden verslagen: <span id="enemiesDefeatedStat">0</span></div>
                <div>Vijanden doorgekomen: <span id="enemiesLeakedStat">0</span></div>
                <div>Koning HP: <span id="kingHealthStat">100</span>/100</div>
            </div>
            <button class="menu-button" style="margin-top: 1rem;" onclick="closeWaveCompletion()">Doorgaan</button>
        </div>
    </div>

    <button class="shop-toggle" onclick="toggleShop()">◀</button>
    <div class="shop-sidebar">
        <h2 style="color: #FFD700; font-size: 1.2rem; margin-bottom: 2rem;">Shop</h2>
        <div class="shop-item" onclick="selectCannon()">
            <div style="width: 40px; height: 40px; background-color: #808080;"></div>
            <div>
                <div>Kanon</div>
                <div style="font-size: 0.8rem;">Kosten: 100</div>
            </div>
        </div>
    </div>
    <div class="cannon-preview">
        <div class="cannon-radius"></div>
    </div>

    <audio id="gunshotSound" src="assets/gunshot.mp3" preload="auto"></audio>

    <script>
        let soundEnabled = true;
        const modal = document.getElementById('settingsModal');
        const soundButton = document.getElementById('soundButton');

        // Maak deze variabelen globaal bovenaan het script
        let currentWave = 1;
        let isWaveInProgress = false;
        let enemiesKilled = 0;
        let enemiesFinished = 0;
        let waveConfig = null;
        let kingHealth = 100;
        const ENEMY_DAMAGE = 15; // Schade die vijanden doen aan de koning
        const ENEMY_HP = 10;     // HP van de vijanden
        const CANNON_DAMAGE = 2; // Schade van het kanon

        function startGame() {
            document.querySelector('.game-container').style.display = 'none';
            document.getElementById('gameView').style.display = 'block';
            document.querySelector('.shop-toggle').style.display = 'block';
        }

        function showInstructions() {
            console.log("Toon instructies...");
        }

        function showSettings() {
            modal.style.display = "flex";
        }

        function closeSettings() {
            modal.style.display = "none";
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            soundButton.textContent = soundEnabled ? "AAN" : "UIT";
        }

        // Sluit modal als er buiten wordt geklikt
        window.onclick = function(event) {
            if (event.target == modal) {
                closeSettings();
            }
        }

        const waveStatus = document.getElementById('waveStatus');

        function getWaveConfig(waveNumber) {
            const configs = {
                1: { enemies: 5, speed: 10 },
                2: { enemies: 8, speed: 9 },
                3: { enemies: 10, speed: 8 },
                4: { enemies: 13, speed: 7 }
            };
            return configs[waveNumber] || configs[4]; // Standaard naar wave 4 config als er geen andere is
        }

        function updateWaveNumber() {
            document.getElementById('waveNumber').textContent = currentWave;
        }

        function updateWaveStatus(status) {
            waveStatus.textContent = status;
        }

        function updateKingHealth() {
            const fillElement = document.querySelector('.king-hp-fill');
            const percentage = (kingHealth / 100) * 100;
            fillElement.style.width = percentage + '%';
            
            // Verander kleur gebaseerd op HP percentage
            if (percentage > 60) {
                fillElement.style.backgroundColor = '#2ecc71'; // Groen
            } else if (percentage > 30) {
                fillElement.style.backgroundColor = '#f1c40f'; // Geel
            } else {
                fillElement.style.backgroundColor = '#e74c3c'; // Rood
            }
        }

        function startWave() {
            if (isWaveInProgress) return;
            
            console.log(`Wave ${currentWave} gestart!`);
            isWaveInProgress = true;
            updateWaveStatus("Wave in progress...");
            
            const waveButton = document.querySelector('.wave-button');
            waveButton.classList.add('disabled');
            
            waveConfig = getWaveConfig(currentWave);
            enemiesKilled = 0;
            enemiesFinished = 0;
            let enemyCount = 0;  // Toevoegen van enemyCount voor spawn controle
            
            const spawnInterval = setInterval(() => {
                if (enemyCount >= waveConfig.enemies) {  // Check op enemyCount in plaats van enemiesFinished
                    clearInterval(spawnInterval);
                    return;
                }
                
                const enemy = document.createElement('div');
                enemy.className = 'enemy';
                enemy.style.animation = `followPath ${waveConfig.speed}s linear`;
                enemy.dataset.health = ENEMY_HP;

                // Voeg HP bar toe aan vijand
                const hpBar = document.createElement('div');
                hpBar.className = 'hp-bar';
                const hpFill = document.createElement('div');
                hpFill.className = 'hp-fill';
                hpFill.style.width = '100%';
                hpBar.appendChild(hpFill);
                enemy.appendChild(hpBar);

                const enemyImg = document.createElement('img');
                enemyImg.src = 'assets/patato-knight.png';
                enemyImg.alt = 'Enemy';
                
                enemy.appendChild(enemyImg);
                document.querySelector('.game-map').appendChild(enemy);
                
                enemy.addEventListener('animationend', () => {
                    enemy.remove();
                    enemiesFinished++;
                    kingHealth -= ENEMY_DAMAGE;
                    updateKingHealth(); // Update koning HP bar
                    
                    if (kingHealth <= 0) {
                        alert('Game Over! De koning is verslagen!');
                        location.reload();
                        return;
                    }
                    
                    if (enemiesKilled + enemiesFinished === waveConfig.enemies) {
                        endWave();
                    }
                });

                enemyCount++;  // Increment enemyCount na het spawnen
            }, 1000);
        }

        // Initialiseer wave status
        updateWaveStatus("Klaar om te starten");

        function buyTower(type) {
            console.log(`Toren gekocht: ${type}`);
        }

        const waveCompletionModal = document.getElementById('waveCompletionModal');
        const completedWaveNumber = document.getElementById('completedWaveNumber');

        function showWaveCompletion(waveNumber) {
            completedWaveNumber.textContent = waveNumber;
            document.getElementById('enemiesDefeatedStat').textContent = enemiesKilled;
            document.getElementById('enemiesLeakedStat').textContent = enemiesFinished;
            document.getElementById('kingHealthStat').textContent = kingHealth;
            waveCompletionModal.style.display = "flex";
        }

        function closeWaveCompletion() {
            waveCompletionModal.style.display = "none";
            const waveButton = document.querySelector('.wave-button');
            waveButton.classList.remove('disabled');
            
            if (currentWave <= 4 && kingHealth > 0) {
                updateWaveStatus("Klaar om te starten");
            } else {
                if (kingHealth > 0) {
                    showWaveCompletion(4);
                    updateWaveStatus("Alle waves voltooid!");
                }
            }
        }

        let isShopOpen = false;
        let selectedTower = null;
        let canPlaceTower = true;
        const preview = document.querySelector('.cannon-preview');
        const gameMap = document.querySelector('.game-map');

        function toggleShop() {
            isShopOpen = !isShopOpen;
            document.querySelector('.shop-sidebar').classList.toggle('open');
            document.querySelector('.shop-toggle').textContent = isShopOpen ? '▶' : '◀';
        }

        function selectCannon() {
            selectedTower = 'cannon';
            preview.style.display = 'block';
            document.querySelectorAll('.shop-item').forEach(item => {
                item.classList.add('selected');
            });
            
            // Voeg mouse move event toe
            gameMap.addEventListener('mousemove', movePreview);
            gameMap.addEventListener('click', placeCannon);
        }

        function movePreview(e) {
            if (!selectedTower) return;
            
            const rect = gameMap.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            preview.style.left = x + 'px';
            preview.style.top = y + 'px';

            // Check of we op het pad zijn
            const paths = document.querySelectorAll('.path, .path-curve');
            canPlaceTower = true;

            // Check voor overlap met pad
            paths.forEach(path => {
                const pathRect = path.getBoundingClientRect();
                if (e.clientX >= pathRect.left && e.clientX <= pathRect.right &&
                    e.clientY >= pathRect.top && e.clientY <= pathRect.bottom) {
                    canPlaceTower = false;
                }
            });

            // Check voor overlap met andere kanonnen
            const cannons = document.querySelectorAll('.placed-cannon');
            cannons.forEach(cannon => {
                const cannonRect = cannon.getBoundingClientRect();
                const distance = Math.sqrt(
                    Math.pow((e.clientX - (cannonRect.left + cannonRect.width/2)), 2) +
                    Math.pow((e.clientY - (cannonRect.top + cannonRect.height/2)), 2)
                );
                
                if (distance < 40) { // 40px is de minimale afstand tussen kanonnen
                    canPlaceTower = false;
                }
            });

            preview.style.backgroundColor = canPlaceTower ? 
                'rgba(90, 90, 90, 0.5)' : 
                'rgba(255, 0, 0, 0.5)';
        }

        function placeCannon(e) {
            if (!selectedTower || !canPlaceTower) return;

            const rect = gameMap.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const cannon = document.createElement('div');
            cannon.className = 'placed-cannon';
            cannon.style.left = (x - 20) + 'px';
            cannon.style.top = (y - 10) + 'px';

            // Geef elk kanon zijn eigen canShoot property
            cannon.canShoot = true;  // Verplaatst van lokale variabele naar cannon property

            // Voeg alleen de loop toe
            const barrel = document.createElement('div');
            barrel.className = 'cannon-barrel';
            cannon.appendChild(barrel);

            // Richt het kanon initieel naar het pad
            const paths = document.querySelectorAll('.path, .path-curve');
            let closestPoint = null;
            let minDistance = Infinity;

            paths.forEach(path => {
                const pathRect = path.getBoundingClientRect();
                const pathCenterX = pathRect.left + pathRect.width / 2;
                const pathCenterY = pathRect.top + pathRect.height / 2;
                
                const distance = Math.sqrt(
                    Math.pow(pathCenterX - e.clientX, 2) +
                    Math.pow(pathCenterY - e.clientY, 2)
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPoint = { x: pathCenterX, y: pathCenterY };
                }
            });

            if (closestPoint) {
                const angle = Math.atan2(
                    closestPoint.y - e.clientY,
                    closestPoint.x - e.clientX
                );
                cannon.style.transform = `rotate(${angle}rad)`;
            }

            // Voeg kanon logica toe
            let canShoot = true;
            const radius = 100;

            function checkTargets() {
                if (!isWaveInProgress) return;

                const cannonRect = cannon.getBoundingClientRect();
                const cannonCenterX = cannonRect.left + cannonRect.width / 2;
                const cannonCenterY = cannonRect.top + cannonRect.height / 2;

                const enemies = document.querySelectorAll('.enemy');
                for (const enemy of enemies) {
                    if (!enemy.isConnected) continue;

                    const enemyRect = enemy.getBoundingClientRect();
                    const enemyCenterX = enemyRect.left + enemyRect.width / 2;
                    const enemyCenterY = enemyRect.top + enemyRect.height / 2;

                    const distance = Math.sqrt(
                        Math.pow(enemyCenterX - cannonCenterX, 2) +
                        Math.pow(enemyCenterY - cannonCenterY, 2)
                    );

                    if (distance <= radius) {
                        const angle = Math.atan2(
                            enemyCenterY - cannonCenterY,
                            enemyCenterX - cannonCenterX
                        );
                        cannon.style.transform = `rotate(${angle}rad)`;

                        if (cannon.canShoot) {
                            shoot(enemy, cannonCenterX, cannonCenterY, enemyCenterX, enemyCenterY);
                        }
                    }
                }
            }

            function shoot(target, startX, startY, targetX, targetY) {
                if (!cannon.canShoot || !target || !target.isConnected) return;  // Check cannon.canShoot
                
                cannon.canShoot = false;  // Gebruik cannon.canShoot

                // Speel het schiet geluid af als geluid aan staat
                if (soundEnabled) {
                    const gunshot = document.getElementById('gunshotSound');
                    gunshot.currentTime = 0; // Reset het geluid voor snelle herhalingen
                    gunshot.play().catch(error => console.log("Audio afspelen mislukt:", error));
                }

                // Voeg recoil animatie toe
                const currentRotation = cannon.style.transform;
                cannon.style.setProperty('--rotation', currentRotation);
                cannon.classList.add('shooting');
                
                // Voeg muzzle flash toe
                const flash = document.createElement('div');
                flash.className = 'muzzle-flash';
                cannon.appendChild(flash);
                flash.style.animation = 'flash 0.15s ease-out';
                
                // Verwijder flash na animatie
                setTimeout(() => {
                    flash.remove();
                    cannon.classList.remove('shooting');
                }, 150);

                // Maak en schiet kogel
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                bullet.style.left = startX + 'px';
                bullet.style.top = startY + 'px';
                bullet.style.setProperty('--targetX', `${targetX - startX}px`);
                bullet.style.setProperty('--targetY', `${targetY - startY}px`);
                
                document.body.appendChild(bullet);
                bullet.style.animation = 'shoot 0.2s linear forwards';

                bullet.addEventListener('animationend', () => {
                    if (target.isConnected) {
                        let enemyHealth = parseInt(target.dataset.health) - CANNON_DAMAGE;
                        target.dataset.health = enemyHealth;
                        
                        // Update vijand HP bar
                        const hpFill = target.querySelector('.hp-fill');
                        const percentage = (enemyHealth / ENEMY_HP) * 100;
                        hpFill.style.width = percentage + '%';
                        
                        // Verander kleur gebaseerd op HP percentage
                        if (percentage > 60) {
                            hpFill.style.backgroundColor = '#2ecc71';
                        } else if (percentage > 30) {
                            hpFill.style.backgroundColor = '#f1c40f';
                        } else {
                            hpFill.style.backgroundColor = '#e74c3c';
                        }
                        
                        if (enemyHealth <= 0) {
                            target.remove();
                            enemiesKilled++;
                            
                            if (typeof waveConfig !== 'undefined' && 
                                waveConfig !== null && 
                                enemiesKilled + enemiesFinished === waveConfig.enemies) {
                                endWave();
                            }
                        }
                    }
                    bullet.remove();
                });

                // Update de cooldown timer
                setTimeout(() => {
                    cannon.canShoot = true;  // Reset cannon.canShoot
                }, 800);
            }

            // Start check interval
            setInterval(checkTargets, 100);

            gameMap.appendChild(cannon);

            // Reset selectie
            selectedTower = null;
            preview.style.display = 'none';
            document.querySelectorAll('.shop-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            gameMap.removeEventListener('mousemove', movePreview);
            gameMap.removeEventListener('click', placeCannon);
        }

        // Nieuwe functie voor wave completion
        function endWave() {
            isWaveInProgress = false;
            if (currentWave < 4 && kingHealth > 0) {
                currentWave++;
                updateWaveNumber();
                showWaveCompletion(currentWave - 1);
            } else {
                if (kingHealth > 0) {
                    showWaveCompletion(4);
                    updateWaveStatus("Alle waves voltooid!");
                }
            }
        }

        // Initialiseer koning HP bar
        updateKingHealth();
    </script>
</body>
</html> 